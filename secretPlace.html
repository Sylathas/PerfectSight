<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>PERFECT SIGHT ADMIN</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://unpkg.com/jquery-scrollify@1.0.21/jquery.scrollify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery.scrollto@2.1.3/jquery.scrollTo.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body id="secretPlace">
    <div id="login">
        <h1>PERFECT SIGHT SHELL</h1>
        <label for="username">Username:</label><br>
        <input type="text" id="username" name="username" value=""><br><br>
        <label for="password">Password:</label><br>
        <input type="text" id="password" name="pasword" value=""><br><br><br>
        <button id="loginButton">Login</button><br>
    </div>
    <div style="display: none;" id="logged">
        <h1>INSERT NEW RELEASE</h1>
        <form>
            <label for="name">Nome</label>
            <input type="text" id="name" name="name" value=""><br><br>
            <label for="bandcamp">Link:</label>
            <input type="text" id="bandcamp" name="bandcamp" value=""><br><br>
            <label for="crediti">Crediti:</label>
            <div id="inputs">
                <input type="text" id="crediti1" class="creditiInput" name="crediti" value="" placeholder="1">
                <input type="text" id="crediti2" class="creditiInput" name="crediti" value="" placeholder="2">
                <input type="text" id="crediti3" class="creditiInput" name="crediti" value="" placeholder="3">
                <input type="text" id="crediti4" class="creditiInput" name="crediti" value="" placeholder="4">
                <input type="text" id="crediti5" class="creditiInput" name="crediti" value="" placeholder="5">
                <input type="text" id="crediti6" class="creditiInput" name="crediti" value="" placeholder="6">
                <input type="text" id="crediti7" class="creditiInput" name="crediti" value="" placeholder="7">
                <input type="text" id="crediti8" class="creditiInput" name="crediti" value="" placeholder="8">
                <input type="text" id="crediti9" class="creditiInput" name="crediti" value="" placeholder="9"><br>
            </div>
            <label for="crediti">Instagram Handles:</label>
            <div id="inputs">
                <input type="text" id="instagram1" class="instagramInput" name="instagram" value="" placeholder="1">
                <input type="text" id="instagram2" class="instagramInput" name="instagram" value="" placeholder="2">
                <input type="text" id="instagram3" class="instagramInput" name="instagram" value="" placeholder="3">
                <input type="text" id="instagram4" class="instagramInput" name="instagram" value="" placeholder="4">
                <input type="text" id="instagram5" class="instagramInput" name="instagram" value="" placeholder="5">
                <input type="text" id="instagram6" class="instagramInput" name="instagram" value="" placeholder="6">
                <input type="text" id="instagram7" class="instagramInput" name="instagram" value="" placeholder="7">
                <input type="text" id="instagram8" class="instagramInput" name="instagram" value="" placeholder="8">
                <input type="text" id="instagram9" class="instagramInput" name="instagram" value="" placeholder="9"><br>
            </div>
            <label for="crediti">Counter:</label><br>
            <div id="PS">PS<input type="text" id="counter" name="counter" value=""></div><br><br>
            <label for="desc">Descrizione:</label>
            <textarea rows="5" cols="80" id="desc"></textarea><br><br>
            <label for="desc">Cover:</label>
            <input type="file" id="cover" value="upload" /><br><br>
        </form>

        <h2 style="margin-bottom:0">Assicurati che tutte le info siano corrette.</h2>
        <h2 style="margin-top:0">Non potrai modificarle in seguito.</h2>
        <button id="uploadButton">Upload</button><br><br>
        <div id="uploadState">Stato Upload: Non Avviato</div><br><br>
    </div>

    <script type="module">

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js'
        import { getDatabase, set, ref } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-storage.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDrPGPN4HziI-0MhSJ-y2khecmbdFu1NNg",
            authDomain: "perfect-sight.firebaseapp.com",
            databaseURL: "https://perfect-sight-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "perfect-sight",
            storageBucket: "perfect-sight.appspot.com",
            messagingSenderId: "122633512609",
            appId: "1:122633512609:web:ba72bd469e82c3b1acb2e0"
        };

        const app = initializeApp(firebaseConfig);

        const auth = getAuth(app);
        document.getElementById("loginButton").onclick = function () {
            signInWithEmailAndPassword(auth, document.getElementById("username").value, document.getElementById("password").value)
                .then((userCredential) => {
                    console.log("Logged");
                    document.getElementById("logged").style.display = "inline";
                    document.getElementById("login").style.display = "none";
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    console.log(errorCode, errorMessage);
                });
        }

        document.getElementById("uploadButton").onclick = function () {
            console.log("Uploading...");

            const db = getDatabase();
            const storage = getStorage(app);

            var name = document.getElementById("name").value;
            var bandcamp = document.getElementById("bandcamp").value;
            var desc = document.getElementById("desc").value;
            var cover = document.getElementById("cover").files;
            var counter = document.getElementById("counter").value;
            var crediti = [];
            var handles = [];

            for (var i = 1; i <= 9; i++) {
                if (document.getElementById("crediti" + i).value != "") {
                    crediti.push(document.getElementById("crediti" + i).value);
                }
                if (document.getElementById("instagram" + i).value != "") {
                    handles.push(document.getElementById("instagram" + i).value);
                }
            }

            console.log("Name: " + name + ", Link: " + bandcamp + ", Credits: " + crediti + ", Handles: " + handles + ", Descrizione: " + desc)

            if (name != "" && desc != "" && bandcamp != "" && crediti.length != 0 && handles.length != 0 && cover.length != 0) {
                const storageReference = storageRef(storage, name);
                const uploadTask = uploadBytesResumable(storageReference, cover[0]);
                uploadTask.on('state_changed',
                    (snapshot) => {
                        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                        document.getElementById("uploadState").innerHTML = "Stato Upload: " + progress + "% completato. Non chiudere la finestra!";
                    },
                    (error) => {
                        document.getElementById("uploadState").innerHTML = "Stato Upload: Fallito. Errore: " + error.message;
                    },
                    () => {
                        getDownloadURL(uploadTask.snapshot.ref).then((downloadURL) => {
                            set(ref(db, 'releases/' + name), {
                                cover: downloadURL,
                                bandcamp: bandcamp,
                                crediti: crediti,
                                handles: handles,
                                desc: desc,
                                counter: counter
                            });
                        });
                        document.getElementById("uploadState").innerHTML = "Stato Upload: Completato!";
                    }
                );
            } else { document.getElementById("uploadState").innerHTML = "Stato Upload: Fallito. Errore: Campo vuoto."; }
        }
    </script>
</body>

</html>